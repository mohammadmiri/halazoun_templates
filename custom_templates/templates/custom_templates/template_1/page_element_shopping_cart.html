{% load static %}


<div class="shopping-cart">
    <div class="states-wrapper d-flex justify-content-center">
        <div class="w-50 d-none d-md-block">
            <div class="d-flex align-items-center p-3">
                <div class="state-logo state-color d-inline-block p-2 passed" data-tab-index="1">
                    <div class="d-flex justify-content-center color-light-gray p-3 h1"><i class="fas fa-shopping-bag"></i></div>
                    <div class="text-center color-dark-gray h6 h-0">سبد خرید</div>
                </div>
                <div class="state-splitter state-color border rounded d-inline-block h-100 w-10" data-tab-index="2"></div>
                <div class="state-logo state-color d-inline-block p-2" data-tab-index="2">
                    <div class="d-flex justify-content-center color-light-gray p-3 h1"><i class="fas fa-truck"></i></div>
                    <div class="text-center color-dark-gray h6 h-0">اطلاعات ارسال</div>
                </div>
                <div class="state-splitter state-color border rounded d-inline-block h-100 w-10" data-tab-index="3"></div>
                <div class="state-logo state-color d-inline-block p-2" data-tab-index="3">
                    <div class="d-flex justify-content-center color-light-gray p-3 h1"><i class="fas fa-money-check"></i></div>
                    <div class="text-center color-dark-gray h6 h-0">نحوه پرداخت</div>
                </div>
                <div class="state-splitter state-color border rounded d-inline-block h-100 w-10" data-tab-index="4"></div>
                <div class="state-logo state-color d-inline-block p-2" data-tab-index="4">
                    <div class="d-flex justify-content-center color-light-gray p-3 h1"><i class="fas fa-clipboard-check"></i></div>
                    <div class="text-center color-dark-gray h6 h-0">اتمام خرید</div>
                </div>
            </div>
        </div>
    </div>

    <div class="order-state active state-shopping-cart mt-3 p-5 color-dark-gray" data-tab-index="1">
        <div class="row m-5 h4">
            <div class="col-md-4">کالا</div>
            <div class="col-md-2 d-flex justify-content-center">قیمت</div>
            <div class="col-md-2 d-flex justify-content-center">تعداد</div>
            <div class="col-md-2 d-flex justify-content-center">جمع قیمت</div>
            <div class="col-md-2"></div>
        </div>
        <div class="products-wrapper" id="shopping_cart_product_wrapper">
        </div>
        <div class="total-price row mt-5 ml-2 color-dark-gray">
            <div class="col-md-8"></div>
            <div class="col-md-4 col-sm-12 border-shadow p-3">
                <span class="float-right h5">مبلغ کل سبد خرید:</span>
                <span class="float-left h5">
                    <span class="price-string">2589000</span>
                    <span>تومان</span>
                </span>
            </div>
        </div>
        <div class="row mt-5 ml-2 mr-2 color-dark-gray">
            <a href="homepage" class="simple-link col-md-2 text-center p-2 border-shadow color-dark-gray">
                <span class="col-md-2 d-inline-block"><i class="fas fa-chevron-right"></i></span>
                <span class="col-md-9 d-inline-block">صفحه‌ی اصلی</span>
            </a>
            <div class="col-md-8"></div>
            <div data-tab-index="2"
                 class="state-changer simple-link hover-pointer col-md-2 text-center p-2 border-shadow color-dark-gray">
                <span class="col-md-9 d-inline-block">ثبت سفارش</span>
                <span class="col-md-2 d-inline-block"><i class="fas fa-chevron-left"></i></span>
            </div>
        </div>
    </div>

    <div class="order-state state-delivery-form mt-3 p-5 color-dark-gray" data-tab-index="2">
        <div class="row">
            <div class="col-md-5 col-sm-12">
                <div class="input-group" dir="ltr">
                    <div class="input-group-prepend">
                      <div class="input-group-text" id="btnGroupAddon">اعمال تخفیف</div>
                    </div>
                    <input type="text" class="form-control" placeholder="کد تخفیف" aria-label="Input group example" aria-describedby="btnGroupAddon">
                </div>
                <div class="pb-3 mt-4 h6 clear-fix border-bottom">
                    <span class="float-right">مبلغ کل سبد خرید:</span>
                    <span class="float-left">
                        <span class="shopping-cart-price">54000</span>
                        <span>تومان</span>
                    </span>
                </div>
                <div class="pb-3 mt-4 h6 clear-fix border-bottom">
                    <span class="float-right">مبلغ قابل پرداخت:</span>
                    <span class="float-left font-weight-bold">
                        <span class="shopping-cart-price">54000</span>
                        <span>تومان</span>
                    </span>
                </div>
            </div>
            <div class="col-md-7">
                <form>
                    <div>
                        <div class="col-md-3 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right">نام</div>
                            <div><input class="form-control" name="first_name"></div>
                        </div>
                        <div class="col-md-3 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right">نام خانوادگی</div>
                            <div><input class="form-control" name="last_name"></div>
                        </div>
                        <div class="col-md-5 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right">ایمیل</div>
                            <div><input class="form-control" name="email"></div>
                        </div>
                    </div>
                    <div>
                        <div class="col-md-4 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right">استان</div>
                            <div><select class="form-control" name="state"></select></div>
                        </div>
                        <div class="col-md-4 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right ">شهر</div>
                            <div><select class="form-control" name="city"></select></div>
                        </div>
                        <div class="col-md-3 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right">کد پستی</div>
                            <div><input class="form-control" name="postal_code"></div>
                        </div>
                    </div>
                    <div>
                        <div class="col-md-5 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right">شماره موبایل</div>
                            <div><input class="form-control" name="mobile_number"></div>
                        </div>
                        <div class="col-md-6 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right">تلفن ثابت</div>
                            <div><input class="form-control" name="phone_number"></div>
                        </div>
                    </div>
                    <div>
                        <div class="col-md-11 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right">نشانی</div>
                            <div><textarea class="form-control" name="mobile_number"></textarea></div>
                        </div>
                    </div>
                    <div>
                        <div class="col-md-11 col-sm-12 p-2 d-inline-block">
                            <div class="mb-2 text-right">توضیحات(اختیاری)</div>
                            <div><textarea class="form-control" name="additional_info"></textarea></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="row mt-5 ml-2 mr-2 color-dark-gray">
            <div data-tab-index="1"
                 class="state-changer simple-link hover-pointer col-md-2 text-center p-2 border-shadow color-dark-gray">
                <span class="col-md-2 d-inline-block"><i class="fas fa-chevron-right"></i></span>
                <span class="col-md-9 d-inline-block">سبد خرید</span>
            </div>
            <div class="col-md-8"></div>
            <div data-tab-index="3"
                 class="state-changer simple-link hover-pointer col-md-2 text-center p-2 border-shadow color-dark-gray">
                <span class="col-md-9 d-inline-block">پرداخت</span>
                <span class="col-md-2 d-inline-block"><i class="fas fa-chevron-left"></i></span>
            </div>
        </div>
    </div>

    <div class="order-state state-payment mt-3 p-5 color-dark-gray" data-tab-index="3">
        <div class="row">
            <div class="col-md-5 p-2">
                <div class="p-3 pr-5 pl-5 mt-4 h5 clear-fix border-bottom">
                    <span class="float-right">مبلغ کل سبد خرید:</span>
                    <span class="float-left">
                        <span class="shopping-cart-price">54000</span>
                        <span>تومان</span>
                    </span>
                </div>
                <div class="p-3 pr-5 pl-5 mt-4 h5 clear-fix border-bottom">
                    <span class="float-right">مبلغ قابل پرداخت:</span>
                    <span class="float-left font-weight-bold">
                        <span class="shopping-cart-price">54000</span>
                        <span>تومان</span>
                    </span>
                </div>
            </div>
            <div class="col-md-7 p-2">
                <div class="border-shadow border-light rounded p-4">
                    <div class="border border-success rounded d-flex justify-content-center align-items-center">
                        <div class="payment-logo-wrapper m-4">
                            <img src="{% static 'custom_templates/img/background.jpg' %}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-5 ml-2 mr-2 color-dark-gray">
            <div data-tab-index="2"
                 class="state-changer simple-link hover-pointer col-md-2 text-center p-2 border-shadow color-dark-gray">
                <span class="col-md-2 d-inline-block"><i class="fas fa-chevron-right"></i></span>
                <span class="col-md-9 d-inline-block">فرم ارسال</span>
            </div>
            <div class="col-md-8"></div>
            <a id="submit-order" class="simple-link col-md-2 text-center p-2 border-shadow color-dark-gray">
                <span class="col-md-9 d-inline-block">صفحه‌ی پرداخت</span>
                <span class="col-md-2 d-inline-block"><i class="fas fa-chevron-left"></i></span>
            </a>
        </div>
    </div>
</div>

<div id="loading-icon">
    <div class="d-flex loading-icon w-100 h-100 justify-content-center align-items-center">
        <svg width="200px"  height="200px"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="lds-ripple" style="background: none;"><circle cx="50" cy="50" r="39.9335" fill="none" ng-attr-stroke="{{config.c1}}" ng-attr-stroke-width="{{config.width}}" stroke="#ef5661" stroke-width="2"><animate attributeName="r" calcMode="spline" values="0;40" keyTimes="0;1" dur="1" keySplines="0 0.2 0.8 1" begin="-0.5s" repeatCount="indefinite"></animate><animate attributeName="opacity" calcMode="spline" values="1;0" keyTimes="0;1" dur="1" keySplines="0.2 0 0.8 1" begin="-0.5s" repeatCount="indefinite"></animate></circle><circle cx="50" cy="50" r="25.3164" fill="none" ng-attr-stroke="{{config.c2}}" ng-attr-stroke-width="{{config.width}}" stroke="#888888" stroke-width="2"><animate attributeName="r" calcMode="spline" values="0;40" keyTimes="0;1" dur="1" keySplines="0 0.2 0.8 1" begin="0s" repeatCount="indefinite"></animate><animate attributeName="opacity" calcMode="spline" values="1;0" keyTimes="0;1" dur="1" keySplines="0.2 0 0.8 1" begin="0s" repeatCount="indefinite"></animate></circle></svg>
    </div>
</div>

<style>
    .shopping-cart{
        color: #45424e;
    }
    .shopping-cart .simple-link:hover{
        text-decoration: none;
    }
    .shopping-cart .color-light-gray{
        color: #cccccc;
    }
    .shopping-cart .color-dark-gray{
        color: #777777;
    }
    .shopping-cart .border-thin{
        border: 1px solid;
    }
    .shopping-cart .border-shadow{
        box-shadow: 0 0 10px #cccccc;
    }
    .shopping-cart .border-gray{
        border-color: #dddddd;
    }

    .shopping-cart .states-wrapper .passed, .shopping-cart .states-wrapper .passed div{
        color: #8acddb;
        border-color: #8acddb !important;
    }
    .shopping-cart .states-wrapper .state-logo{
        width: 17.5%;
    }
    .shopping-cart .states-wrapper .state-splitter{
        width: 10%;
    }
    .shopping-cart .states-wrapper .state img{
        width: 80px;
        height: 80px;
    }
    .shopping-cart .states-wrapper .h-0{
        height: 0;
    }

    .shopping-cart .order-state{
        display: none;
    }
    .shopping-cart .order-state.active{
        display: block;
    }

    .shopping-cart .state-shopping-cart .products-wrapper img{
        width: 60px;
        height: 60px;
    }
    .shopping-cart .state-shopping-cart .border-transparent{
        border-color: transparent;
    }
    .shopping-cart .state-shopping-cart .bg-light-gray{
        background: #eeeeee;
    }
    .shopping-cart .state-shopping-cart .bg-dark-gray{
        background: #cccccc;
    }

    .shopping-cart .state-payment .payment-logo-wrapper img{
        width: 100px;
        height: 100px;
    }
    .loading-icon{
        position: fixed;
        top: 0;
        left: 0;
        z-index: 500;
        background-color: rgba(255, 255, 255, 0.7);
    }
    .hidden-item{
        display: none;
    }
</style>

<script>
    show_loading();
    let base_url = 'http://127.0.0.1:8000/';
    let shoppping_cart_session_key = 'shopping_cart_session';
    let session = localStorage.getItem(shoppping_cart_session_key);
    let shopping_cart = undefined;

    function get_shop_name(){
        return 'bamilo';
    }

    (function () {
        let state_changers = document.querySelectorAll('.state-changer');
        for(let i=0; i<state_changers.length; i++){
            state_changers[i].addEventListener('click', function (event) {
                let button = event.target.closest('.state-changer');
                let tab_index = button.getAttribute('data-tab-index');
                let target = document.querySelector('.order-state[data-tab-index="'+tab_index+'"]');
                hide_states();
                target.classList.add('active');
                refresh_states_logos(tab_index);
            });
        }
        function hide_states() {
            let order_states = document.querySelectorAll('.order-state');
            for(let i=0; i<order_states.length; i++){
                order_states[i].classList.remove('active');
            }
        }
        function refresh_states_logos(tab_index) {
            let states_colors = document.querySelectorAll('.states-wrapper .state-color');
            for(let i=0; i<states_colors.length; i++){
                let state_tab_index = states_colors[i].getAttribute('data-tab-index');
                if(parseInt(tab_index) >= parseInt(state_tab_index)){
                    states_colors[i].classList.add('passed');
                }
                else{
                    states_colors[i].classList.remove('passed');
                }
            }
        }


        {#   state-shopping-cart#}
        fix_prices();

        $('#shopping_cart_product_wrapper').on('click', '.increase-product-count', function (event) {
            let product = $(event.target).closest('.product');
            update_shopping_cart_product(get_shop_name(), session, product.attr('product-id'), 1);
        });
        $('#shopping_cart_product_wrapper').on('click', '.decrease-product-count', function (event) {
            let product = $(event.target).closest('.product');
            update_shopping_cart_product(get_shop_name(), session, product.attr('product-id'), -1);
        });
        $('#shopping_cart_product_wrapper').on('click', '.remove-product', function (event) {
            let product = event.target.closest('.product');
            product.parentElement.removeChild(product);
            fix_prices();
        });

        let product_counts = $('.state-shopping-cart .products-wrapper .product-count-input');
        for(let i=0; i<product_counts.length; i++){
            product_counts[i].on('change', fix_prices);
        }
    })();

    function fix_prices() {
        let sum = 0;
        $('.state-shopping-cart .products-wrapper .product').each(function(index ,value){
            let count = parseInt($(this).find('.product-count-input').val());
            let price = parseInt($(this).find('.price').text());
            $(this).find('.product-total-price').text(count * price);
            sum += count * price;
        });
        $('.state-shopping-cart .total-price .price-string').text(sum);
    }

    function hide_loading(){
        $('#loading-icon').addClass('hidden-item');
    }

    function show_loading(){
        $('#loading-icon').removeClass('hidden-item');
    }

    // initializing shopping cart

    let product_item_string = "<div product-id='' class='product row m-2 p-2 border-thin border-transparent border-shadow rounded'>"+
                "<div class='col-md-4'>" +
                    "<img id='image' class='rounded'>" +
                    "<span id='name' class='mr-3'>کفش</span>"+
                "</div>"+
                "<div class='col-md-2 d-flex align-items-center justify-content-center'>"+
                    "<span id='price' class='price h5'></span>"+
                    "<span class='h6 mr-2'>تومان</span> " +
                "</div>"+
                "<div class='col-md-2 d-flex align-items-center justify-content-center'>"+
                    "<div class='product-count rounded d-flex align-items-center bg-dark-gray'>"+
                        "<div class='increase-product-count hover-pointer m-1 pt-1 pr-2 pl-2'><i class='fas fa-plus'></i></div>"+
                        "<div class='m-1 h3'><input id='number' class='product-count-input form-control text-center text-font bg-light-gray' type='text'' value='5'></div>"+
                        "<div class='decrease-product-count hover-pointer m-1 pt-1 pr-2 pl-2'><i class='fas fa-minus'></i></div>"+
                    "</div>"+
                "</div>"+
                "<div class='col-md-2 d-flex align-items-center justify-content-center'>"+
                    "<span id='total_price' class='product-total-price h5'>25000</span>"+
                    "<span class='h6 mr-2'>تومان</span>"+
                "</div>"+
                "<div class='remove-product hover-pointer col-md-2 d-flex align-items-center h4'><i class='far fa-trash-alt'></i></div>"+
            "</div>";


    $.ajax({
            url: base_url+'shop/customer/get_shopping_cart/',
            data: {'shop_name': 'bamilo', 'session': session},
            type: 'GET',
            datatype: "json",
            cache: false,
            traditional: true,
            header: {},
            success: function (data,  textStatus, xhr) {
                if(xhr.status < 400){
                    shopping_cart = data.shopping_cart;
                    add_to_shopping_cart_wrapper(shopping_cart, product_item_string);
                    hide_loading();
                }
            },
            error: function (xhr, status, error) {
                hide_loading();
            }
        });

    function add_to_shopping_cart_wrapper(shopping_cart, product_item_string){
        $('#shopping_cart_product_wrapper').empty();
        for(let i=0; i<shopping_cart.shoppingcartproduct_set.length; i++){
            let product_item = $(product_item_string);
            product_item.attr({'product-id': shopping_cart.shoppingcartproduct_set[i].product.id});
            product_item.find('#image').attr({'src': shopping_cart.shoppingcartproduct_set[i].product.image.image});
            product_item.find('#name').text(shopping_cart.shoppingcartproduct_set[i].product.name);
            product_item.find('#number').val(shopping_cart.shoppingcartproduct_set[i].number);
            if(shopping_cart.shoppingcartproduct_set[i].product.has_discount){
                product_item.find('#price').text(shopping_cart.shoppingcartproduct_set[i].product.discount_price);
            }
            else{
                product_item.find('#price').text(shopping_cart.shoppingcartproduct_set[i].product.base_price);
            }
            $('#shopping_cart_product_wrapper').append(product_item);
        }
        fix_prices();
    }

    function update_shopping_cart_product(shop_name, session, product_id, amount){
        show_loading();
        $.ajax({
            url: base_url+'shop/customer/add_to_shopping_cart/',
            data: {'shop_name': 'bamilo', 'session': session, 'product_id':product_id, 'amount': amount},
            type: 'POST',
            datatype: "json",
            cache: false,
            traditional: true,
            header: {},
            success: function (data,  textStatus, xhr) {
                if(xhr.status < 400){
                    shopping_cart = data.shopping_cart;
                    add_to_shopping_cart_wrapper(shopping_cart, product_item_string);
                    hide_loading();
                }
            },
            error: function (xhr, status, error) {
                hide_loading();
            }
        });
    }

    $('#submit-order').click(function(event){
        $.ajax({
            url: base_url+'shop/customer/add_to_shopping_cart/',
            data: {'shop_name': 'bamilo', 'session': session, 'product_id':product_id, 'amount': amount},
            type: 'POST',
            datatype: "json",
            cache: false,
            traditional: true,
            header: {},
            success: function (data,  textStatus, xhr) {
                if(xhr.status < 400){
                    shopping_cart = data.shopping_cart;
                    add_to_shopping_cart_wrapper(shopping_cart, product_item_string);
                    hide_loading();
                }
            },
            error: function (xhr, status, error) {
                hide_loading();
            }
        });
    })

</script>
